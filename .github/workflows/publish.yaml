# See:
# - https://github.com/tauri-apps/tauri-action
# - https://pytauri.github.io/pytauri/latest/usage/tutorial/build-standalone/

name: publish

on:
  workflow_dispatch:
  push:
    branches:
      - release

defaults:
  run:
    shell: bash
    working-directory: desktop

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-15-intel
            target: x86_64-apple-darwin
            mise_install_args: ""
          - platform: macos-15
            target: aarch64-apple-darwin
            mise_install_args: ""
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            mise_install_args: ""
          - platform: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            mise_install_args: "python aqua:astral-sh/uv node rust aqua:BurntSushi/ripgrep aqua:tomnomnom/gron github:jgm/pandoc aqua:pnpm/pnpm"
          - platform: windows-2022
            target: x86_64-pc-windows-msvc
            mise_install_args: ""
          # - platform: windows-11-arm
          #   target: aarch64-pc-windows-msvc
          #   mise_install_args: "python aqua:astral-sh/uv node rust aqua:BurntSushi/ripgrep aqua:tomnomnom/gron github:jgm/pandoc aqua:pnpm/pnpm"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v5

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          working_directory: desktop
          install: true
          install_args: ${{ matrix.mise_install_args }}

      - name: Install system dependencies (ubuntu only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install project dependencies
        run: mise x pnpm -- pnpm install

      - name: Download embedded Python (macOS/Linux)
        if: runner.os != 'Windows'
        run: mise x uv -- uv run ./scripts/download_python.py

      - name: Download embedded Python (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: mise.exe x uv -- uv.exe run .\scripts\download_python.py

      - name: Bundle pdftotext (macOS)
        if: runner.os == 'macOS'
        run: mise x uv -- uv run ./scripts/download_pdftotext.py --require

      - name: Bundle pdftotext (Linux x86_64)
        if: runner.os == 'Linux' && !contains(matrix.target, 'aarch64')
        run: mise x uv -- uv run ./scripts/download_pdftotext.py --require

      - name: Build bundle (macOS/Linux)
        if: runner.os != 'Windows'
        run: mise x uv -- uv run ./scripts/build_app.py

      - name: Zip macOS .app bundle
        if: runner.os == 'macOS'
        run: |
          shopt -s nullglob
          for app in target/**/bundle/macos/*.app; do
            zip="${app%.*}-macos-${{ matrix.target }}.zip"
            echo "Zipping $app -> $zip"
            ditto -c -k --sequesterRsrc --keepParent "$app" "$zip"
          done

      - name: Build bundle (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          mise.exe x uv -- uv.exe run .\scripts\download_pdftotext.py --require
          mise.exe x uv -- uv.exe run .\scripts\build_app.py

      - name: Read app version
        id: get_version
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs')
            const p = 'desktop/src-tauri/tauri.conf.json'
            const cfg = JSON.parse(fs.readFileSync(p, 'utf8'))
            core.setOutput('version', cfg.version)

      - name: Create/Update GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ steps.get_version.outputs.version }}
          name: v${{ steps.get_version.outputs.version }}
          body: See the assets to download this version and install.
          draft: true
          fail_on_unmatched_files: false
          files: |
            desktop/target/**/bundle/dmg/*.dmg
            desktop/target/**/bundle/macos/*.zip
            desktop/target/**/bundle/msi/*.msi
            desktop/target/**/bundle/nsis/*.exe
            desktop/target/**/bundle/deb/*.deb
            desktop/target/**/bundle/rpm/*.rpm

# See:
# - https://github.com/tauri-apps/tauri-action
# - https://pytauri.github.io/pytauri/latest/usage/tutorial/build-standalone/

name: publish

on:
  workflow_dispatch:
  push:
    branches:
      - release

defaults:
  run:
    shell: bash
    working-directory: desktop

jobs:
  publish-tauri:
    permissions:
      contents: write
    env:
      TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
      TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-15-intel
            target: x86_64-apple-darwin
            mise_install_args: ""
          - platform: macos-15
            target: aarch64-apple-darwin
            mise_install_args: ""
          - platform: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            mise_install_args: ""
          - platform: ubuntu-22.04-arm
            target: aarch64-unknown-linux-gnu
            mise_install_args: ""
          - platform: windows-2022
            target: x86_64-pc-windows-msvc
            mise_install_args: ""
          # - platform: windows-11-arm
          #   target: aarch64-pc-windows-msvc
          #   mise_install_args: "python aqua:astral-sh/uv node rust aqua:BurntSushi/ripgrep aqua:tomnomnom/gron github:jgm/pandoc aqua:pnpm/pnpm"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup mise
        uses: jdx/mise-action@v3
        with:
          working_directory: desktop
          install: true
          install_args: ${{ matrix.mise_install_args }}

      - name: Install system dependencies (ubuntu only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            desktop-file-utils \
            libfuse2

      - name: Install project dependencies
        run: mise x pnpm -- pnpm install

      - name: Download embedded Python (macOS/Linux)
        if: runner.os != 'Windows'
        run: mise x uv -- uv run ./scripts/download_python.py

      - name: Download embedded Python (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: mise.exe x uv -- uv.exe run .\scripts\download_python.py

      - name: Bundle pdftotext (macOS)
        if: runner.os == 'macOS'
        run: mise x uv -- uv run ./scripts/download_pdftotext.py --require

      - name: Bundle pdftotext (Linux x86_64)
        if: runner.os == 'Linux' && !contains(matrix.target, 'aarch64')
        run: mise x uv -- uv run ./scripts/download_pdftotext.py --require

      - name: Build bundle (macOS/Linux)
        if: runner.os != 'Windows'
        env:
          APPIMAGE_EXTRACT_AND_RUN: '1'
          # DEBUG: '1'
        run: mise x uv -- uv run ./scripts/build_app.py

      - name: Build bundle (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          mise.exe x uv -- uv.exe run .\scripts\download_pdftotext.py --require
          mise.exe x uv -- uv.exe run .\scripts\build_app.py

      - name: Read app version
        id: get_version
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs')
            const p = 'desktop/src-tauri/tauri.conf.json'
            const cfg = JSON.parse(fs.readFileSync(p, 'utf8'))
            core.setOutput('version', cfg.version)

      - name: Generate updater manifest for this target
        id: updater_manifest
        uses: actions/github-script@v8
        env:
          TARGET_TRIPLE: ${{ matrix.target }}
          VERSION: ${{ steps.get_version.outputs.version }}
        with:
          script: |
            const fs = require('fs')
            const path = require('path')
            const repo = process.env.GITHUB_REPOSITORY
            const version = process.env.VERSION
            const triple = process.env.TARGET_TRIPLE

            function findFile(root, predicate) {
              if (!fs.existsSync(root)) return null
              const entries = fs.readdirSync(root, { withFileTypes: true })
              for (const entry of entries) {
                const full = path.join(root, entry.name)
                if (entry.isDirectory()) {
                  const found = findFile(full, predicate)
                  if (found) return found
                } else if (predicate(full)) {
                  return full
                }
              }
              return null
            }

            if (!version) {
              core.warning('No version found, skipping updater manifest generation')
              return
            }

            const targetRoot = path.join('desktop', 'target')

            let updaterPattern
            if (triple.includes('apple-darwin')) {
              updaterPattern = p => p.includes(path.join('bundle', 'macos')) && p.endsWith('.app.tar.gz')
            } else if (triple.includes('unknown-linux-gnu')) {
              updaterPattern = p => p.includes(path.join('bundle', 'appimage')) && p.endsWith('.AppImage')
            } else if (triple.includes('pc-windows-msvc')) {
              updaterPattern = p => p.includes(path.join('bundle', 'nsis')) && p.endsWith('-setup.exe')
            } else {
              core.warning(`Unsupported target triple ${triple}, skipping updater manifest`)
              return
            }

            const updaterPath = findFile(targetRoot, updaterPattern)
            if (!updaterPath) {
              core.warning(`No updater bundle found for ${triple}, skipping updater manifest`)
              return
            }

            const sigPath = `${updaterPath}.sig`
            if (!fs.existsSync(sigPath)) {
              core.warning(`No signature file found at ${sigPath}, skipping updater manifest`)
              return
            }

            const signature = fs.readFileSync(sigPath, 'utf8').trim()

            let os, arch
            if (triple.includes('apple-darwin')) {
              os = 'darwin'
              arch = triple.startsWith('x86_64') ? 'x86_64' : 'aarch64'
            } else if (triple.includes('unknown-linux-gnu')) {
              os = 'linux'
              arch = triple.startsWith('x86_64') ? 'x86_64' : 'aarch64'
            } else {
              os = 'windows'
              arch = 'x86_64'
            }

            const targetKey = `${os}-${arch}`
            const outDir = path.join('desktop', 'updates')
            fs.mkdirSync(outDir, { recursive: true })
            const assetName = path.basename(updaterPath)
            const tag = `v${version}`
            const url = `https://github.com/${repo}/releases/download/${tag}/${assetName}`
            const outPath = path.join(outDir, `updates-${targetKey}.json`)

            const payload = {
              version,
              pub_date: new Date().toISOString(),
              url,
              signature,
              notes: ''
            }

            fs.writeFileSync(outPath, JSON.stringify(payload), 'utf8')
            core.info(`Wrote updater manifest to ${outPath}`)
            core.setOutput('json_path', outPath)

      - name: Create/Update GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: v${{ steps.get_version.outputs.version }}
          name: v${{ steps.get_version.outputs.version }}
          body: See the assets to download this version and install.
          draft: true
          fail_on_unmatched_files: false
          files: |
            desktop/target/**/bundle/dmg/*.dmg
            desktop/target/**/bundle/macos/*.app.tar.gz
            desktop/target/**/bundle/msi/*.msi
            desktop/target/**/bundle/nsis/*.exe
            desktop/target/**/bundle/deb/*.deb
            desktop/target/**/bundle/rpm/*.rpm
            desktop/target/**/bundle/appimage/*.AppImage
            desktop/updates/*.json
